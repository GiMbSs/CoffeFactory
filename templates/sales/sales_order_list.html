{% extends 'base.html' %}
{% load static %}

{% block title %}Pedidos de Venda - Coffee Factory Management System{% endblock %}

{% block extra_css %}
<style>
    .order-card {
        transition: all 0.3s ease;
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .filter-panel {
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.05) 0%, rgba(210, 105, 30, 0.05) 100%);
    }
    .status-badge {
        transition: all 0.3s ease;
    }
    .priority-indicator {
        width: 4px;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        border-radius: 0 4px 4px 0;
    }
    .priority-high { background: #ef4444; }
    .priority-medium { background: #f59e0b; }
    .priority-low { background: #10b981; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 flex items-center">
                <i class="fas fa-shopping-cart text-coffee-600 dark:text-coffee-400 mr-3"></i>
                Pedidos de Venda
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                Gerencie todos os pedidos de venda da sua empresa
            </p>
        </div>
        <div class="flex space-x-3">
            <button class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center">
                <i class="fas fa-download mr-2"></i>
                Exportar
            </button>
            <a href="{% url 'sales:sales_order_create' %}" 
               class="bg-coffee-600 hover:bg-coffee-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Novo Pedido
            </a>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center">
            <div class="p-2 rounded-full bg-blue-100 dark:bg-blue-900">
                <i class="fas fa-shopping-cart text-blue-600 dark:text-blue-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Total</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">{{ stats.total_orders }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center">
            <div class="p-2 rounded-full bg-yellow-100 dark:bg-yellow-900">
                <i class="fas fa-clock text-yellow-600 dark:text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Pendentes</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">{{ stats.pending_orders }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center">
            <div class="p-2 rounded-full bg-purple-100 dark:bg-purple-900">
                <i class="fas fa-cogs text-purple-600 dark:text-purple-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Em Produção</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">{{ stats.production_orders }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center">
            <div class="p-2 rounded-full bg-green-100 dark:bg-green-900">
                <i class="fas fa-check text-green-600 dark:text-green-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Entregues</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">{{ stats.delivered_orders }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center">
            <div class="p-2 rounded-full bg-emerald-100 dark:bg-emerald-900">
                <i class="fas fa-dollar-sign text-emerald-600 dark:text-emerald-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Faturamento</p>
                <p class="text-xl font-bold text-gray-900 dark:text-white">R$ {{ stats.total_revenue|floatformat:0 }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-panel bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-coffee-200 dark:border-coffee-700 mb-8">
    <form method="get" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Search -->
            <div class="md:col-span-2">
                <label for="search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Buscar Pedido
                </label>
                <div class="relative">
                    <input type="text" 
                           name="search" 
                           id="search"
                           value="{{ request.GET.search }}"
                           placeholder="Número do pedido, cliente..."
                           class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-coffee-500 focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Status -->
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Status
                </label>
                <select name="status" id="status"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-coffee-500 focus:border-transparent">
                    <option value="">Todos os status</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendente</option>
                    <option value="confirmed" {% if request.GET.status == 'confirmed' %}selected{% endif %}>Confirmado</option>
                    <option value="in_production" {% if request.GET.status == 'in_production' %}selected{% endif %}>Em Produção</option>
                    <option value="delivered" {% if request.GET.status == 'delivered' %}selected{% endif %}>Entregue</option>
                    <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelado</option>
                </select>
            </div>
            
            <!-- Date From -->
            <div>
                <label for="date_from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Data Inicial
                </label>
                <input type="date" 
                       name="date_from" 
                       id="date_from"
                       value="{{ request.GET.date_from }}"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-coffee-500 focus:border-transparent">
            </div>
            
            <!-- Date To -->
            <div>
                <label for="date_to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Data Final
                </label>
                <input type="date" 
                       name="date_to" 
                       id="date_to"
                       value="{{ request.GET.date_to }}"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-coffee-500 focus:border-transparent">
            </div>
        </div>
        
        <div class="flex justify-between items-center">
            <div class="flex space-x-2">
                <button type="submit" 
                        class="bg-coffee-600 hover:bg-coffee-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    Filtrar
                </button>
                <a href="{% url 'sales:sales_order_list' %}" 
                   class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Limpar
                </a>
            </div>
            
            <!-- Sort Options -->
            <div class="flex items-center space-x-2">
                <label for="sort" class="text-sm text-gray-600 dark:text-gray-400">Ordenar por:</label>
                <select name="sort" id="sort" onchange="this.form.submit()"
                        class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                    <option value="-order_date" {% if request.GET.sort == '-order_date' %}selected{% endif %}>Data (Mais recente)</option>
                    <option value="order_date" {% if request.GET.sort == 'order_date' %}selected{% endif %}>Data (Mais antiga)</option>
                    <option value="-total_amount" {% if request.GET.sort == '-total_amount' %}selected{% endif %}>Valor (Maior)</option>
                    <option value="total_amount" {% if request.GET.sort == 'total_amount' %}selected{% endif %}>Valor (Menor)</option>
                    <option value="customer__name" {% if request.GET.sort == 'customer__name' %}selected{% endif %}>Cliente (A-Z)</option>
                </select>
            </div>
        </div>
    </form>
</div>

<!-- Orders Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
    {% for order in orders %}
    <div class="order-card bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-coffee-200 dark:border-coffee-700 relative overflow-hidden">
        <!-- Priority Indicator -->
        <div class="priority-indicator 
            {% if order.priority == 'high' %}priority-high
            {% elif order.priority == 'medium' %}priority-medium
            {% else %}priority-low{% endif %}"></div>
        
        <div class="p-6 pl-8">
            <!-- Header -->
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white text-lg">
                        #{{ order.order_number }}
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        {{ order.order_date|date:"d/m/Y H:i" }}
                    </p>
                </div>
                <span class="status-badge px-3 py-1 text-xs font-medium rounded-full
                    {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
                    {% elif order.status == 'confirmed' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300
                    {% elif order.status == 'in_production' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300
                    {% elif order.status == 'delivered' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                    {% elif order.status == 'cancelled' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                    {% endif %}">
                    {{ order.get_status_display }}
                </span>
            </div>
            
            <!-- Customer -->
            <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-coffee-100 dark:bg-coffee-900 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-{% if order.customer.customer_type == 'company' %}building{% else %}user{% endif %} text-coffee-600 dark:text-coffee-400 text-sm"></i>
                </div>
                <div>
                    <p class="font-medium text-gray-900 dark:text-white text-sm">
                        {{ order.customer.get_display_name|truncatechars:25 }}
                    </p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">
                        {{ order.customer.code }}
                    </p>
                </div>
            </div>
            
            <!-- Order Details -->
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Itens:</span>
                    <span class="font-medium text-gray-900 dark:text-white">{{ order.items.count }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Subtotal:</span>
                    <span class="font-medium text-gray-900 dark:text-white">R$ {{ order.subtotal|floatformat:2 }}</span>
                </div>
                {% if order.discount_amount > 0 %}
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Desconto:</span>
                    <span class="font-medium text-red-600 dark:text-red-400">-R$ {{ order.discount_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                {% if order.tax_amount > 0 %}
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Impostos:</span>
                    <span class="font-medium text-gray-900 dark:text-white">R$ {{ order.tax_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between text-base font-bold border-t border-gray-200 dark:border-gray-700 pt-2">
                    <span class="text-gray-900 dark:text-white">Total:</span>
                    <span class="text-coffee-600 dark:text-coffee-400">R$ {{ order.total_amount|floatformat:2 }}</span>
                </div>
            </div>
            
            <!-- Delivery Information -->
            {% if order.delivery_date %}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-truck text-gray-400 mr-2"></i>
                    <div>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Entrega prevista:</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">
                            {{ order.delivery_date|date:"d/m/Y" }}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="flex space-x-2">
                <a href="{% url 'sales:sales_order_detail' order.pk %}" 
                   class="flex-1 bg-coffee-600 hover:bg-coffee-700 text-white px-3 py-2 rounded-lg text-sm font-medium text-center transition-colors">
                    <i class="fas fa-eye mr-1"></i>
                    Detalhes
                </a>
                <a href="{% url 'sales:sales_order_edit' order.pk %}" 
                   class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium text-center transition-colors">
                    <i class="fas fa-edit mr-1"></i>
                    Editar
                </a>
                <button onclick="printOrder({{ order.pk }})"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-print"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12">
        <i class="fas fa-shopping-cart text-gray-400 text-6xl mb-4"></i>
        <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">Nenhum pedido encontrado</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
            {% if request.GET.search %}
                Não encontramos pedidos com os critérios de busca.
            {% else %}
                Comece criando seu primeiro pedido de venda.
            {% endif %}
        </p>
        <a href="{% url 'sales:sales_order_create' %}" 
           class="bg-coffee-600 hover:bg-coffee-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:scale-105 inline-flex items-center">
            <i class="fas fa-plus mr-2"></i>
            Novo Pedido
        </a>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if orders.has_other_pages %}
<div class="mt-8 flex items-center justify-between">
    <div class="text-sm text-gray-600 dark:text-gray-400">
        Mostrando {{ orders.start_index }} a {{ orders.end_index }} de {{ orders.paginator.count }} pedidos
    </div>
    
    <nav class="flex items-center space-x-2">
        {% if orders.has_previous %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ orders.previous_page_number }}" 
           class="px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}
        
        <span class="px-4 py-2 text-sm bg-coffee-600 text-white rounded-lg">
            {{ orders.number }}
        </span>
        
        {% if orders.has_next %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ orders.next_page_number }}" 
           class="px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </nav>
</div>
{% endif %}

<!-- Quick Actions Modal -->
<div id="quickActionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-mx-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ações Rápidas</h3>
        <div class="space-y-3">
            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i class="fas fa-check text-green-600 mr-3"></i>
                Confirmar Pedido
            </button>
            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i class="fas fa-cogs text-purple-600 mr-3"></i>
                Enviar para Produção
            </button>
            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i class="fas fa-truck text-blue-600 mr-3"></i>
                Marcar como Entregue
            </button>
            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i class="fas fa-times text-red-600 mr-3"></i>
                Cancelar Pedido
            </button>
        </div>
        <div class="mt-4 flex justify-end">
            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                Fechar
            </button>
        </div>
    </div>
</div>

<script>
function printOrder(orderId) {
    // Implementar impressão do pedido
    window.open(`/sales/orders/${orderId}/print/`, '_blank');
}

function openQuickActions(orderId) {
    document.getElementById('quickActionsModal').classList.remove('hidden');
    document.getElementById('quickActionsModal').classList.add('flex');
}

function closeModal() {
    document.getElementById('quickActionsModal').classList.add('hidden');
    document.getElementById('quickActionsModal').classList.remove('flex');
}

// Auto-submit form when date fields change
document.getElementById('date_from').addEventListener('change', function() {
    if (this.value && document.getElementById('date_to').value) {
        this.form.submit();
    }
});

document.getElementById('date_to').addEventListener('change', function() {
    if (this.value && document.getElementById('date_from').value) {
        this.form.submit();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        window.location.href = "{% url 'sales:sales_order_create' %}";
    }
});
</script>
{% endblock %}
