{% extends 'base.html' %}
{% load static %}

{% block title %}Pedido #{{ order.order_number }} - Coffee Factory Management System{% endblock %}

{% block extra_css %}
<style>
    .status-timeline {
        position: relative;
    }
    .status-timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #8B4513, #D2691E);
    }
    .timeline-item {
        position: relative;
        padding-left: 50px;
        margin-bottom: 20px;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 14px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #8B4513;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #8B4513;
    }
    .timeline-item.completed::before {
        background: #10b981;
        box-shadow: 0 0 0 3px #10b981;
    }
    .timeline-item.current::before {
        background: #f59e0b;
        box-shadow: 0 0 0 3px #f59e0b;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .info-card {
        transition: all 0.3s ease;
    }
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .item-card {
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.05) 0%, rgba(210, 105, 30, 0.05) 100%);
        border: 1px solid rgba(139, 69, 19, 0.1);
        transition: all 0.3s ease;
    }
    .item-card:hover {
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.08) 0%, rgba(210, 105, 30, 0.08) 100%);
        transform: translateY(-1px);
    }
    .print-button {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
    }
    @media print {
        .no-print { display: none; }
        .print-only { display: block; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8 no-print">
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <div class="w-16 h-16 bg-coffee-100 dark:bg-coffee-900 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-receipt text-coffee-600 dark:text-coffee-400 text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                    Pedido #{{ order.order_number }}
                </h1>
                <p class="text-gray-600 dark:text-gray-400">
                    {{ order.order_date|date:"d/m/Y H:i" }} • {{ order.customer.get_display_name }}
                </p>
                <div class="flex items-center mt-2">
                    <span class="px-3 py-1 text-sm font-medium rounded-full
                        {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
                        {% elif order.status == 'confirmed' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300
                        {% elif order.status == 'in_production' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300
                        {% elif order.status == 'delivered' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                        {% elif order.status == 'cancelled' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                        {% endif %}">
                        {{ order.get_status_display }}
                    </span>
                    {% if order.priority == 'high' %}
                    <span class="ml-2 px-2 py-1 text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 rounded-full">
                        Alta Prioridade
                    </span>
                    {% elif order.priority == 'medium' %}
                    <span class="ml-2 px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300 rounded-full">
                        Prioridade Média
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="flex space-x-3">
            <a href="{% url 'sales:sales_order_list' %}" 
               class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar
            </a>
            <a href="{% url 'sales:sales_order_edit' order.pk %}" 
               class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center">
                <i class="fas fa-edit mr-2"></i>
                Editar
            </a>
            <button onclick="window.print()" 
                    class="print-button bg-coffee-600 hover:bg-coffee-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center">
                <i class="fas fa-print mr-2"></i>
                Imprimir
            </button>
            <div class="relative">
                <button onclick="toggleActionsMenu()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center">
                    <i class="fas fa-cog mr-2"></i>
                    Ações
                    <i class="fas fa-chevron-down ml-2"></i>
                </button>
                <div id="actionsMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-10">
                    <div class="py-1">
                        {% if order.status == 'pending' %}
                        <button onclick="updateStatus('confirmed')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-check text-blue-600 mr-2"></i>
                            Confirmar Pedido
                        </button>
                        {% endif %}
                        {% if order.status == 'confirmed' %}
                        <button onclick="updateStatus('in_production')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-cogs text-purple-600 mr-2"></i>
                            Enviar para Produção
                        </button>
                        {% endif %}
                        {% if order.status == 'in_production' %}
                        <button onclick="updateStatus('delivered')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-truck text-green-600 mr-2"></i>
                            Marcar como Entregue
                        </button>
                        {% endif %}
                        {% if order.status != 'cancelled' and order.status != 'delivered' %}
                        <button onclick="updateStatus('cancelled')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-ban text-red-600 mr-2"></i>
                            Cancelar Pedido
                        </button>
                        {% endif %}
                        <div class="border-t border-gray-200 dark:border-gray-700"></div>
                        <button onclick="duplicateOrder()" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-copy text-coffee-600 mr-2"></i>
                            Duplicar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Header (Only visible when printing) -->
<div class="print-only hidden mb-8">
    <div class="text-center border-b-2 border-coffee-600 pb-4 mb-6">
        <h1 class="text-2xl font-bold text-coffee-600 mb-2">Coffee Factory Management System</h1>
        <h2 class="text-xl font-semibold text-gray-900">Pedido de Venda #{{ order.order_number }}</h2>
        <p class="text-gray-600">{{ order.order_date|date:"d/m/Y H:i" }}</p>
    </div>
</div>

<!-- Order Information Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- Customer Information -->
    <div class="info-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center mb-4">
            <div class="p-2 rounded-full bg-blue-100 dark:bg-blue-900 mr-3">
                <i class="fas fa-{% if order.customer.customer_type == 'company' %}building{% else %}user{% endif %} text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Cliente</h3>
        </div>
        <div class="space-y-2">
            <div>
                <p class="font-medium text-gray-900 dark:text-white">{{ order.customer.get_display_name }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ order.customer.code }}</p>
            </div>
            {% if order.customer.email %}
            <div class="flex items-center text-sm">
                <i class="fas fa-envelope text-gray-400 mr-2 w-4"></i>
                <a href="mailto:{{ order.customer.email }}" class="text-blue-600 dark:text-blue-400 hover:underline">
                    {{ order.customer.email }}
                </a>
            </div>
            {% endif %}
            {% if order.customer.phone %}
            <div class="flex items-center text-sm">
                <i class="fas fa-phone text-gray-400 mr-2 w-4"></i>
                <a href="tel:{{ order.customer.phone }}" class="text-blue-600 dark:text-blue-400 hover:underline">
                    {{ order.customer.phone }}
                </a>
            </div>
            {% endif %}
            {% if order.customer.city %}
            <div class="flex items-center text-sm">
                <i class="fas fa-map-marker-alt text-gray-400 mr-2 w-4"></i>
                <span class="text-gray-900 dark:text-white">{{ order.customer.city }}, {{ order.customer.state }}</span>
            </div>
            {% endif %}
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <a href="{% url 'sales:customer_detail' order.customer.pk %}" 
               class="text-coffee-600 dark:text-coffee-400 hover:text-coffee-700 dark:hover:text-coffee-300 text-sm font-medium">
                Ver detalhes do cliente →
            </a>
        </div>
    </div>
    
    <!-- Order Details -->
    <div class="info-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-coffee-200 dark:border-coffee-700">
        <div class="flex items-center mb-4">
            <div class="p-2 rounded-full bg-coffee-100 dark:bg-coffee-900 mr-3">
                <i class="fas fa-file-alt text-coffee-600 dark:text-coffee-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Detalhes do Pedido</h3>
        </div>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Data do Pedido:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ order.order_date|date:"d/m/Y H:i" }}</span>
            </div>
            {% if order.delivery_date %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Entrega Prevista:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ order.delivery_date|date:"d/m/Y" }}</span>
            </div>
            {% endif %}
            {% if order.payment_terms %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Condições:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ order.payment_terms }}</span>
            </div>
            {% endif %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Prioridade:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ order.get_priority_display }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Última Atualização:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ order.updated_at|date:"d/m/Y H:i" }}</span>
            </div>
        </div>
    </div>
    
    <!-- Financial Summary -->
    <div class="info-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-green-200 dark:border-green-700">
        <div class="flex items-center mb-4">
            <div class="p-2 rounded-full bg-green-100 dark:bg-green-900 mr-3">
                <i class="fas fa-dollar-sign text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Resumo Financeiro</h3>
        </div>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Subtotal:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">R$ {{ order.subtotal|floatformat:2 }}</span>
            </div>
            {% if order.discount_amount > 0 %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Desconto ({{ order.discount_percentage }}%):</span>
                <span class="text-sm font-medium text-red-600 dark:text-red-400">-R$ {{ order.discount_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if order.tax_amount > 0 %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Impostos ({{ order.tax_percentage }}%):</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">R$ {{ order.tax_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if order.shipping_cost > 0 %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-600 dark:text-gray-400">Frete:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">R$ {{ order.shipping_cost|floatformat:2 }}</span>
            </div>
            {% endif %}
            <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-3">
                <span class="text-base font-bold text-gray-900 dark:text-white">Total:</span>
                <span class="text-xl font-bold text-green-600 dark:text-green-400">R$ {{ order.total_amount|floatformat:2 }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Status Timeline -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-coffee-200 dark:border-coffee-700 mb-8">
    <div class="flex items-center mb-6">
        <div class="p-2 rounded-full bg-purple-100 dark:bg-purple-900 mr-3">
            <i class="fas fa-clock text-purple-600 dark:text-purple-400"></i>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Acompanhamento do Status</h2>
    </div>
    
    <div class="status-timeline">
        <div class="timeline-item {% if order.status == 'pending' %}current{% else %}completed{% endif %}">
            <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 dark:text-white">Pedido Criado</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    {{ order.created_at|date:"d/m/Y H:i" }}
                </p>
            </div>
        </div>
        
        <div class="timeline-item {% if order.status == 'confirmed' %}current{% elif order.status in 'in_production,delivered' %}completed{% endif %}">
            <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 dark:text-white">Pedido Confirmado</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    {% if order.status in 'confirmed,in_production,delivered' %}
                        {{ order.updated_at|date:"d/m/Y H:i" }}
                    {% else %}
                        Aguardando confirmação
                    {% endif %}
                </p>
            </div>
        </div>
        
        <div class="timeline-item {% if order.status == 'in_production' %}current{% elif order.status == 'delivered' %}completed{% endif %}">
            <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 dark:text-white">Em Produção</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    {% if order.status in 'in_production,delivered' %}
                        {{ order.updated_at|date:"d/m/Y H:i" }}
                    {% else %}
                        Aguardando produção
                    {% endif %}
                </p>
            </div>
        </div>
        
        <div class="timeline-item {% if order.status == 'delivered' %}completed current{% endif %}">
            <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 dark:text-white">Entregue</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    {% if order.status == 'delivered' %}
                        {{ order.updated_at|date:"d/m/Y H:i" }}
                    {% else %}
                        Aguardando entrega
                    {% endif %}
                </p>
            </div>
        </div>
        
        {% if order.status == 'cancelled' %}
        <div class="timeline-item current">
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg p-4">
                <h4 class="font-medium text-red-900 dark:text-red-100">Pedido Cancelado</h4>
                <p class="text-sm text-red-700 dark:text-red-300 mt-1">
                    {{ order.updated_at|date:"d/m/Y H:i" }}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Order Items -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-coffee-200 dark:border-coffee-700 mb-8">
    <div class="flex items-center mb-6">
        <div class="p-2 rounded-full bg-coffee-100 dark:bg-coffee-900 mr-3">
            <i class="fas fa-list text-coffee-600 dark:text-coffee-400"></i>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Itens do Pedido ({{ order.items.count }})</h2>
    </div>
    
    <div class="space-y-4">
        {% for item in order.items.all %}
        <div class="item-card rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-coffee-100 dark:bg-coffee-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-box text-coffee-600 dark:text-coffee-400"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white">{{ item.product.name }}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            SKU: {{ item.product.sku|default:"N/A" }}
                        </p>
                        {% if item.product.description %}
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            {{ item.product.description|truncatewords:10 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="text-right">
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="text-center">
                            <p class="text-gray-600 dark:text-gray-400">Quantidade</p>
                            <p class="font-medium text-gray-900 dark:text-white">{{ item.quantity }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 dark:text-gray-400">Preço Unit.</p>
                            <p class="font-medium text-gray-900 dark:text-white">R$ {{ item.unit_price|floatformat:2 }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 dark:text-gray-400">Total</p>
                            <p class="font-bold text-coffee-600 dark:text-coffee-400">R$ {{ item.total_price|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8">
            <i class="fas fa-box-open text-gray-400 text-4xl mb-3"></i>
            <p class="text-gray-600 dark:text-gray-400">Nenhum item encontrado</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Notes -->
{% if order.notes %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-coffee-200 dark:border-coffee-700 mb-8">
    <div class="flex items-center mb-4">
        <div class="p-2 rounded-full bg-yellow-100 dark:bg-yellow-900 mr-3">
            <i class="fas fa-sticky-note text-yellow-600 dark:text-yellow-400"></i>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Observações</h2>
    </div>
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
        <p class="text-gray-900 dark:text-white leading-relaxed">{{ order.notes|linebreaks }}</p>
    </div>
</div>
{% endif %}

<script>
function toggleActionsMenu() {
    const menu = document.getElementById('actionsMenu');
    menu.classList.toggle('hidden');
}

function updateStatus(newStatus) {
    if (confirm(`Tem certeza que deseja alterar o status do pedido para "${getStatusDisplayName(newStatus)}"?`)) {
        fetch(`{% url 'sales:sales_order_status_update' %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'status': newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao atualizar status: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao atualizar status');
        });
    }
    
    // Hide menu
    document.getElementById('actionsMenu').classList.add('hidden');
}

function getStatusDisplayName(status) {
    const statusNames = {
        'pending': 'Pendente',
        'confirmed': 'Confirmado',
        'in_production': 'Em Produção',
        'delivered': 'Entregue',
        'cancelled': 'Cancelado'
    };
    return statusNames[status] || status;
}

function duplicateOrder() {
    if (confirm('Tem certeza que deseja duplicar este pedido?')) {
        window.location.href = `{% url 'sales:sales_order_create' %}?duplicate={{ order.pk }}`;
    }
    
    // Hide menu
    document.getElementById('actionsMenu').classList.add('hidden');
}

// Hide actions menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('actionsMenu');
    const button = event.target.closest('[onclick="toggleActionsMenu()"]');
    
    if (!button && !menu.contains(event.target)) {
        menu.classList.add('hidden');
    }
});

// Print styles
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing');
});
</script>
{% endblock %}
